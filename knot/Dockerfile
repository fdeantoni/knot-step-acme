FROM debian:stable-slim

# Knot DNS + tools for healthcheck (dig)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      knot knot-dnsutils dnsutils ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Runtime dirs / perms
RUN useradd -r -s /usr/sbin/nologin -d /var/lib/knot -U knot || true && \
    mkdir -p /etc/knot /var/lib/knot /run/knot && \
    chown -R knot:knot /var/lib/knot /run/knot

# Config + zone data
COPY knot.conf /etc/knot/knot.conf
COPY test.zone /var/lib/knot/test.zone
RUN keymgr -t cm-key hmac-sha256 > /tmp/cm-key.conf && \
  sed -i '/^# autogenerated key section/r /tmp/cm-key.conf' /etc/knot/knot.conf && \
  rm -f /tmp/cm-key.conf
RUN chown -R knot:knot /etc/knot /var/lib/knot

EXPOSE 53/udp 53/tcp

# Answer must be available for healthcheck:
HEALTHCHECK --interval=5s --timeout=3s --retries=20 \
  CMD sh -c "dig @127.0.0.1 test SOA +time=1 +tries=1 +short | grep -q 'test.'"

CMD ["/usr/sbin/knotd","-c","/etc/knot/knot.conf"]
